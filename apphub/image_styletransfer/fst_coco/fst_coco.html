

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fast Style Transfer with FastEstimator &mdash; FastEstimator 1.0b0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Tabular" href="../../tabular.html" />
    <link rel="prev" title="Image Style Transfer" href="../../image_styletransfer.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> FastEstimator
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../learn.html">Learn</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../apphub.html">Example</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../NLP.html">NLP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../image_classification.html">Image Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../image_generation.html">Image Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../image_segmentation.html">Image Segmentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../image_styletransfer.html">Image Style Transfer</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Fast Style Transfer with FastEstimator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Step-1:-Input-Pipeline">Step 1: Input Pipeline</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Step-2:-Network">Step 2: Network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Step-3:-Estimator">Step 3: Estimator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Inference">Inference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tabular.html">Tabular</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">FastEstimator</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../apphub.html">Example</a> &raquo;</li>
        
          <li><a href="../../image_styletransfer.html">Image Style Transfer</a> &raquo;</li>
        
      <li>Fast Style Transfer with FastEstimator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/apphub/image_styletransfer/fst_coco/fst_coco.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Fast-Style-Transfer-with-FastEstimator">
<h1>Fast Style Transfer with FastEstimator<a class="headerlink" href="#Fast-Style-Transfer-with-FastEstimator" title="Permalink to this headline">¶</a></h1>
<p>In this notebook we will demonstrate how to do a neural image style transfer with perceptual loss as described in <a class="reference external" href="https://cs.stanford.edu/people/jcjohns/papers/eccv16/JohnsonECCV16.pdf">Perceptual Losses for Real-Time Style Transfer and Super-Resolution</a>. Typical neural style transfer involves two images, an image containing semantics that you want to preserve and another image serving as a reference style; the first image is often referred as <em>content image</em> and the other image as <em>style
image</em>. In <a class="reference external" href="https://cs.stanford.edu/people/jcjohns/papers/eccv16/JohnsonECCV16.pdf">paper</a> training images of COCO2014 dataset are used to learn the style transfer from any content image.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="kn">import</span> <span class="nn">fastestimator</span> <span class="k">as</span> <span class="nn">fe</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</pre></div>
</div>
</div>
<p>In this notebook we will use <em>Wassily Kandinsky’s Composition 7</em> as a style image. We will also resize the style image to <span class="math notranslate nohighlight">\(256 \times 256\)</span> to make the dimension consistent with that of COCO images.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">style_img_path</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span>
    <span class="s1">&#39;kandinsky.jpg&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://storage.googleapis.com/download.tensorflow.org/example_images/Vassily_Kandinsky%2C_1913_-_Composition_7.jpg&#39;</span>
<span class="p">)</span>

<span class="n">style_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">style_img_path</span><span class="p">)</span>
<span class="n">style_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">style_img</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
<span class="n">style_img</span> <span class="o">=</span> <span class="p">(</span><span class="n">style_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">127.5</span>
<span class="n">style_img_t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">style_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="n">style_img_disp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">((</span><span class="n">style_img</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">style_img_disp</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Wassily Kandinsky</span><span class="se">\&#39;</span><span class="s1">s Composition 7&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/apphub_image_styletransfer_fst_coco_fst_coco_3_0.png" src="../../../_images/apphub_image_styletransfer_fst_coco_fst_coco_3_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#Parameters</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">validation_steps</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">img_path</span> <span class="o">=</span> <span class="s1">&#39;panda.jpeg&#39;</span>
<span class="n">saved_model_path</span> <span class="o">=</span> <span class="s1">&#39;style_transfer_net_epoch_1_step_41390.h5&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="Step-1:-Input-Pipeline">
<h2>Step 1: Input Pipeline<a class="headerlink" href="#Step-1:-Input-Pipeline" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Downloading-the-data">
<h3>Downloading the data<a class="headerlink" href="#Downloading-the-data" title="Permalink to this headline">¶</a></h3>
<p>First, we will download training images of COCO2014 dataset via our dataset API. The images will be first downloaded. Then, a csv file containing relative paths to these images will be created. The root path of the downloaded images will be parent_path. Downloading the images will take awhile.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">fastestimator.dataset.mscoco</span> <span class="k">import</span> <span class="n">load_data</span>
<span class="n">train_csv</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
reusing existing dataset
</pre></div></div>
</div>
<p>Once finished downloading images, we need to define an <em>Operator</em> to recale pixel values from <span class="math notranslate nohighlight">\([0, 255]\)</span> to <span class="math notranslate nohighlight">\([-1, 1]\)</span>. We will define our own <code class="docutils literal notranslate"><span class="pre">Rescale</span></code> class in which we define the data transform logic inside <code class="docutils literal notranslate"><span class="pre">forward</span></code> method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">fastestimator.op</span> <span class="k">import</span> <span class="n">TensorOp</span>

<span class="k">class</span> <span class="nc">Rescale</span><span class="p">(</span><span class="n">TensorOp</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">127.5</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Creating-tfrecords">
<h3>Creating tfrecords<a class="headerlink" href="#Creating-tfrecords" title="Permalink to this headline">¶</a></h3>
<p>Once the images are downloaded, we will create tfrecords using <code class="docutils literal notranslate"><span class="pre">RecordWriter</span></code>. Each row of the csv file will be used by <code class="docutils literal notranslate"><span class="pre">ImageReader</span></code> to read in the image using <code class="docutils literal notranslate"><span class="pre">cv2.imread</span></code>. Then, we resize the images to <span class="math notranslate nohighlight">\(256 \times 256\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">fastestimator.op.numpyop</span> <span class="k">import</span> <span class="n">ImageReader</span><span class="p">,</span> <span class="n">Resize</span>
<span class="kn">from</span> <span class="nn">fastestimator.util</span> <span class="k">import</span> <span class="n">RecordWriter</span>
<span class="n">tfr_save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;tfrecords&#39;</span><span class="p">)</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">RecordWriter</span><span class="p">(</span>
    <span class="n">train_data</span><span class="o">=</span><span class="n">train_csv</span><span class="p">,</span>
    <span class="n">save_dir</span><span class="o">=</span><span class="n">tfr_save_dir</span><span class="p">,</span>
    <span class="n">ops</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ImageReader</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">parent_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">),</span>
        <span class="n">Resize</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">outputs</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
    <span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Defining-an-instance-of-Pipeline">
<h3>Defining an instance of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code><a class="headerlink" href="#Defining-an-instance-of-Pipeline" title="Permalink to this headline">¶</a></h3>
<p>We can now define an instance of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="p">[</span><span class="n">Rescale</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Step-2:-Network">
<h2>Step 2: Network<a class="headerlink" href="#Step-2:-Network" title="Permalink to this headline">¶</a></h2>
<p>Once <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> is defined, we need to define network architecture, losses, and the forward pass of batch data.</p>
<div class="section" id="Defining-model-architecture">
<h3>Defining model architecture<a class="headerlink" href="#Defining-model-architecture" title="Permalink to this headline">¶</a></h3>
<p>We first create a <code class="docutils literal notranslate"><span class="pre">FEModel</span></code> instance which collects the following: * model definition * model name * loss name * optimizer</p>
<p>The architecture of the model is a modified resnet.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">fastestimator.architecture.stnet</span> <span class="k">import</span> <span class="n">styleTransferNet</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_def</span><span class="o">=</span><span class="n">styleTransferNet</span><span class="p">,</span>
                <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;style_transfer_net&quot;</span><span class="p">,</span>
                <span class="n">loss_name</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Defining-Loss">
<h3>Defining Loss<a class="headerlink" href="#Defining-Loss" title="Permalink to this headline">¶</a></h3>
<p>The perceptual loss described in the <a class="reference external" href="https://cs.stanford.edu/people/jcjohns/papers/eccv16/JohnsonECCV16.pdf">paper</a> is computed based on intermediate layers of VGG16 pretrained on ImageNet; specifically, <code class="docutils literal notranslate"><span class="pre">relu1_2</span></code>, <code class="docutils literal notranslate"><span class="pre">relu2_2</span></code>, <code class="docutils literal notranslate"><span class="pre">relu3_3</span></code>, and <code class="docutils literal notranslate"><span class="pre">relu4_3</span></code> of VGG16 are used. The <em>style</em> loss term is computed as the squared l2 norm of the difference in Gram Matrix of these feature maps between an input image and the reference stlye image. The <em>content</em> loss is simply l2 norm of the
difference in <code class="docutils literal notranslate"><span class="pre">relu3_3</span></code> of the input image and the reference style image. In addition, the method also uses total variation loss to enforce spatial smoothness in the output image. The final loss is weighted sum of the style loss term, the content loss term (feature reconstruction term in the <a class="reference external" href="https://cs.stanford.edu/people/jcjohns/papers/eccv16/JohnsonECCV16.pdf">paper</a>), and the total variation term.</p>
<p>We first define a custom <code class="docutils literal notranslate"><span class="pre">TensorOp</span></code> that outputs intermediate layers of VGG16. Given these intermediate layers returned by the loss network as a dictionary, we define a custom <code class="docutils literal notranslate"><span class="pre">Loss</span></code> class that encapsulates all the logics of the loss calculation. Since <code class="docutils literal notranslate"><span class="pre">Loss</span></code> is also yet another <code class="docutils literal notranslate"><span class="pre">TensorOp</span></code>, the final loss value is returned by <code class="docutils literal notranslate"><span class="pre">forward</span></code> method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">fastestimator.architecture.stnet</span> <span class="k">import</span> <span class="n">lossNet</span>
<span class="kn">from</span> <span class="nn">fastestimator.op.tensorop</span> <span class="k">import</span> <span class="n">Loss</span>

<span class="k">class</span> <span class="nc">ExtractVGGFeatures</span><span class="p">(</span><span class="n">TensorOp</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vgg</span> <span class="o">=</span> <span class="n">lossNet</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vgg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StyleContentLoss</span><span class="p">(</span><span class="n">Loss</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style_weight</span><span class="p">,</span> <span class="n">content_weight</span><span class="p">,</span> <span class="n">tv_weight</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style_weight</span> <span class="o">=</span> <span class="n">style_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_weight</span> <span class="o">=</span> <span class="n">content_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tv_weight</span> <span class="o">=</span> <span class="n">tv_weight</span>

    <span class="k">def</span> <span class="nf">calculate_style_recon_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="n">y_true_gram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gram_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
        <span class="n">y_pred_gram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_gram_matrix</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="n">y_diff_gram</span> <span class="o">=</span> <span class="n">y_pred_gram</span> <span class="o">-</span> <span class="n">y_true_gram</span>
        <span class="n">y_norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_diff_gram</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">y_norm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_feature_recon_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="n">y_diff</span> <span class="o">=</span> <span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_true</span>
        <span class="n">num_elts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_prod</span><span class="p">(</span><span class="n">y_diff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">y_diff_norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_diff</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">/</span> <span class="n">num_elts</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">y_diff_norm</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_gram_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">num_elts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">gram_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bijc,bijd-&gt;bcd&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">gram_matrix</span> <span class="o">/=</span> <span class="n">num_elts</span>
        <span class="k">return</span> <span class="n">gram_matrix</span>

    <span class="k">def</span> <span class="nf">calculate_total_variation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span><span class="n">y_pred</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_style</span><span class="p">,</span> <span class="n">y_content</span><span class="p">,</span> <span class="n">image_out</span> <span class="o">=</span> <span class="n">data</span>

        <span class="n">style_loss</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_style_recon_loss</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_style</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">])]</span>
        <span class="n">style_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">style_loss</span><span class="p">)</span>
        <span class="n">style_loss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_weight</span>

        <span class="n">content_loss</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_feature_recon_loss</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_content</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="n">content_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">content_loss</span><span class="p">)</span>
        <span class="n">content_loss</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_weight</span>

        <span class="n">total_variation_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_total_variation</span><span class="p">(</span><span class="n">image_out</span><span class="p">)</span>
        <span class="n">total_variation_reg</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tv_weight</span>
        <span class="k">return</span> <span class="n">style_loss</span> <span class="o">+</span> <span class="n">content_loss</span> <span class="o">+</span> <span class="n">total_variation_reg</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Defining-forward-pass">
<h3>Defining forward pass<a class="headerlink" href="#Defining-forward-pass" title="Permalink to this headline">¶</a></h3>
<p>Having defined the model and the associated loss, we can now define an instance of <code class="docutils literal notranslate"><span class="pre">Network</span></code> that specify forward pass of the batch data in a training loop. FastEstimator takes care of gradient computation and update of the model once this forward pass is defined.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">fastestimator.op.tensorop</span> <span class="k">import</span> <span class="n">ModelOp</span>

<span class="n">style_weight</span><span class="o">=</span><span class="mf">5.0</span>
<span class="n">content_weight</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">tv_weight</span><span class="o">=</span><span class="mf">1e-4</span>

<span class="n">network</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">Network</span><span class="p">(</span><span class="n">ops</span><span class="o">=</span><span class="p">[</span>
    <span class="n">ModelOp</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s2">&quot;image_out&quot;</span><span class="p">),</span>
    <span class="n">ExtractVGGFeatures</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">style_img_t</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s2">&quot;y_style&quot;</span><span class="p">),</span>
    <span class="n">ExtractVGGFeatures</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s2">&quot;y_content&quot;</span><span class="p">),</span>
    <span class="n">ExtractVGGFeatures</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="s2">&quot;image_out&quot;</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="s2">&quot;y_pred&quot;</span><span class="p">),</span>
    <span class="n">StyleContentLoss</span><span class="p">(</span><span class="n">style_weight</span><span class="o">=</span><span class="n">style_weight</span><span class="p">,</span>
                     <span class="n">content_weight</span><span class="o">=</span><span class="n">content_weight</span><span class="p">,</span>
                     <span class="n">tv_weight</span><span class="o">=</span><span class="n">tv_weight</span><span class="p">,</span>
                     <span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="s1">&#39;y_style&#39;</span><span class="p">,</span> <span class="s1">&#39;y_content&#39;</span><span class="p">,</span> <span class="s1">&#39;image_out&#39;</span><span class="p">),</span>
                     <span class="n">outputs</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Step-3:-Estimator">
<h2>Step 3: Estimator<a class="headerlink" href="#Step-3:-Estimator" title="Permalink to this headline">¶</a></h2>
<p>Having defined <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> and <code class="docutils literal notranslate"><span class="pre">Network</span></code>, we can now define <code class="docutils literal notranslate"><span class="pre">Estimator</span></code>. We will use <code class="docutils literal notranslate"><span class="pre">Trace</span></code> to save intermediate models.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">fastestimator.trace</span> <span class="k">import</span> <span class="n">ModelSaver</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="n">model_dir</span><span class="o">=</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
<span class="n">estimator</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">Estimator</span><span class="p">(</span><span class="n">network</span><span class="o">=</span><span class="n">network</span><span class="p">,</span>
                         <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span>
                         <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                         <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                         <span class="n">validation_steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">,</span>
                         <span class="n">traces</span><span class="o">=</span><span class="n">ModelSaver</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;style_transfer_net&quot;</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">model_dir</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>We call <code class="docutils literal notranslate"><span class="pre">fit</span></code> method of <code class="docutils literal notranslate"><span class="pre">Estimator</span></code> to start training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Inference">
<h2>Inference<a class="headerlink" href="#Inference" title="Permalink to this headline">¶</a></h2>
<p>Once the training is finished, we will apply the model to perform the style transfer on arbitrary images. Here we use a photo of a panda.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">test_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
<span class="n">test_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">test_img</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
<span class="n">test_img</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">127.5</span>
<span class="n">test_img_t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">test_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">saved_model_path</span><span class="p">)</span>
<span class="n">trained_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span>
                                           <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span>
                                               <span class="s2">&quot;ReflectionPadding2D&quot;</span><span class="p">:</span><span class="n">fe</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">stnet</span><span class="o">.</span><span class="n">ReflectionPadding2D</span><span class="p">,</span>
                                               <span class="s2">&quot;InstanceNormalization&quot;</span><span class="p">:</span><span class="n">fe</span><span class="o">.</span><span class="n">architecture</span><span class="o">.</span><span class="n">stnet</span><span class="o">.</span><span class="n">InstanceNormalization</span><span class="p">},</span>
                                           <span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">output_img</span> <span class="o">=</span> <span class="n">trained_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_img_t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">output_img_disp</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="n">test_img_disp</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_img</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">test_img_disp</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">style_img_disp</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Style Image&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">output_img_disp</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Transferred Image&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/apphub_image_styletransfer_fst_coco_fst_coco_26_0.png" src="../../../_images/apphub_image_styletransfer_fst_coco_fst_coco_26_0.png" />
</div>
</div>
</div>
</div>
<p>—</p>
<p><a class="reference external" href="https://github.com/fastestimator/fastestimator/blob/master/apphub/image_styletransfer/fst_coco/fst_coco.ipynb">Example Link to GitHub</a></p>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../tabular.html" class="btn btn-neutral float-right" title="Tabular" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../image_styletransfer.html" class="btn btn-neutral" title="Image Style Transfer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, GEHC DataScience

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'1.0b0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>